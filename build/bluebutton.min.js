/* BlueButton.js -- 0.1.0 */

!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.BlueButton=b()}(this,function(){var a=function(){var a=function(a){if(!a||"string"!=typeof a)return null;var b=a.substr(0,4),c=parseInt(a.substr(4,2),10)-1,d=a.substr(6,2),e=new Date(b,c,d),f=6e4*e.getTimezoneOffset();return new Date(e-f)},b=function(a){var c;for(var d in a)a.hasOwnProperty(d)&&(c=a[d],null===c&&delete a[d],c instanceof Object&&(c=b(c)));return a};return{parseDate:a,trim:b}}(),b=function(){var a,b=function(a){function b(a){return{el:a,template:d,tag:e,elsByTag:f,attr:g,val:h,isEmpty:j}}if(a.length){for(var c=[],i=0;i<a.length;i++)c.push(b(a[i]));return c}return b(a)},c=function(a,b,c,d){a=a.getElementsByTagName(b);for(var e=0;e<a.length;e++)if(a[e].getAttribute(c)===d)return a[e]},d=function(a){var d=c(this.el,"templateId","root",a);return d?b(d.parentNode):i()},e=function(a){var c=this.el.getElementsByTagName(a)[0];return c?b(c):i()},f=function(a){return b(this.el.getElementsByTagName(a))},g=function(a){return this.el?this.el.getAttribute(a):null},h=function(){if(!this.el)return null;try{return this.el.childNodes[0].nodeValue}catch(a){return null}},i=function(){var a=n.createElement("empty");return b(a)},j=function(){return"empty"===this.el.tagName.toLowerCase()?!0:!1},k=function(c){if(!c||"string"!=typeof c)return console.log("BB Error: XML data is not a string"),null;var d;if(m)d=a.jsdom(c,a.level(1,"core"));else if(window.DOMParser){var e=new DOMParser;d=e.parseFromString(c,"text/xml")}else try{d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c)}catch(f){console.log("BB ActiveX Exception: Could not parse XML")}return d&&d.documentElement&&!d.getElementsByTagName("parsererror").length?b(d):(console.log("BB Error: Could not parse XML"),null)},l=this,m=!1,n=l.document;return"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(m=!0,a=require("jsdom"),n=new(a.level(1,"core").Document)),{parse:k}}(),c=function(){var a=function(a){var b={F:"female",M:"male",UN:"undifferentiated"};return b[a]||null},b=function(a){var b={N:"annulled",C:"common law",D:"divorced",P:"domestic partner",I:"interlocutory",E:"legally separated",G:"living together",M:"married",O:"other",R:"registered domestic partner",A:"separated",S:"single",U:"unknown",B:"unmarried",T:"unreported",W:"widowed"};return b[a]||null};return{gender:a,maritalStatus:b}}(),d=d||{};d.C32=function(){var b=a.parseDate,d=function(a){return a.section=f,a},e=function(){var a=function(a){for(var b=0;b<this.length;b++)a(this[b])},b=this.elsByTag("entry");return b.each=a,b},f=function(a){var b;switch(a){case"allergies":return b=this.template("2.16.840.1.113883.3.88.11.83.102"),b.entries=e,b;case"demographics":return b=this.template("2.16.840.1.113883.3.88.11.32.1"),b.entries=e,b;case"encounters":return b=this.template("2.16.840.1.113883.3.88.11.83.127"),b.entries=e,b;case"immunizations":return b=this.template("2.16.840.1.113883.3.88.11.83.117"),b.entries=e,b;case"labs":return b=this.template("2.16.840.1.113883.3.88.11.83.122"),b.entries=e,b;case"medications":return b=this.template("2.16.840.1.113883.3.88.11.83.112"),b.entries=e,b;case"problems":return b=this.template("2.16.840.1.113883.3.88.11.83.103"),b.entries=e,b;case"procedures":return b=this.template("2.16.840.1.113883.3.88.11.83.108"),b.entries=e,b;case"vitals":return b=this.template("2.16.840.1.113883.3.88.11.83.119"),b.entries=e,b}return null},g=function(a){var e,f,g={};a=d(a),g.allergies=[];var h=a.section("allergies");h.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.template("2.16.840.1.113883.3.88.11.83.6").tag("code");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem"),j=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.3.88.11.83.6").tag("value");var k=e.attr("displayName"),l=e.attr("code"),m=e.attr("codeSystem"),n=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.1.54").tag("value");var o=e.attr("displayName"),p=e.attr("code"),q=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.1.55").tag("value");var r=e.attr("displayName");e=a.tag("participant").tag("code");var s=e.attr("displayName"),t=e.attr("code"),u=e.attr("codeSystem"),v=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.1.39").tag("value");var w=e.attr("displayName");g.allergies.push({date_range:{start:c,end:d},name:f,code:h,code_system:i,code_system_name:j,status:w,severity:r,reaction:{name:o,code:p,code_system:q},reaction_type:{name:k,code:l,code_system:m,code_system_name:n},allergen:{name:s,code:t,code_system:u,code_system_name:v}})}),g.demographics={};var i=a.section("demographics"),j=i.tag("patientRole");e=j.tag("patient").tag("name");var k=e.tag("prefix").val(),l=e.elsByTag("given"),m=[];for(f=0;f<l.length;f++)m.push(l[f].val());var n=e.tag("family").val();e=j.tag("patient");var o=b(e.tag("birthTime").attr("value")),p=c.gender(e.tag("administrativeGenderCode").attr("code")),q=c.maritalStatus(e.tag("maritalStatusCode").attr("code"));e=j.tag("addr"),l=e.elsByTag("streetAddressLine");var r=[];for(f=0;f<l.length;f++)r.push(l[f].val());var s=e.tag("city").val(),t=e.tag("state").val(),u=e.tag("postalCode").val(),v=e.tag("country").val();e=j.tag("telecom");var w=e.attr("value"),x=null,y=null,z=null,A=j.tag("languageCommunication").tag("languageCode").attr("code"),B=j.tag("raceCode").attr("displayName"),C=j.tag("ethnicGroupCode").attr("displayName"),D=j.tag("religiousAffiliationCode").attr("displayName");e=j.tag("birthplace");var E=e.tag("state").val(),F=e.tag("postalCode").val(),G=e.tag("country").val();e=j.tag("guardian");var H=e.tag("code").attr("displayName"),I=e.tag("telecom").attr("value");e=e.tag("guardianPerson"),l=e.elsByTag("given");var J=[];for(f=0;f<l.length;f++)J.push(l[f].val());var K=e.tag("family").val();e=j.tag("guardian").tag("addr"),l=e.elsByTag("streetAddressLine");var L=[];for(f=0;f<l.length;f++)L.push(l[f].val());var M=e.tag("city").val(),N=e.tag("state").val(),O=e.tag("postalCode").val(),P=e.tag("country").val();e=j.tag("providerOrganization");var Q=e.tag("name").val(),R=e.tag("telecom").attr("value");l=e.elsByTag("streetAddressLine");var S=[];for(f=0;f<l.length;f++)S.push(l[f].val());var T=e.tag("city").val(),U=e.tag("state").val(),V=e.tag("postalCode").val(),W=e.tag("country").val();g.demographics={name:{prefix:k,given:m,family:n},dob:o,gender:p,marital_status:q,address:{street:r,city:s,state:t,zip:u,country:v},phone:{home:w,work:x,mobile:y},email:z,language:A,race:B,ethnicity:C,religion:D,birthplace:{state:E,zip:F,country:G},guardian:{name:{given:J,family:K},relationship:H,address:{street:L,city:M,state:N,zip:O,country:P},phone:{home:I}},provider:{organization:Q,phone:R,address:{street:S,city:T,state:U,zip:V,country:W}}},g.encounters=[];var X=a.section("encounters");X.entries().each(function(a){var c=b(a.tag("effectiveTime").attr("value"));c||(c=b(a.tag("effectiveTime").tag("low").attr("value"))),e=a.tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=e.attr("codeSystemName"),j=e.attr("codeSystemVersion");e=a.tag("value");var k=e.attr("displayName"),m=e.attr("code"),n=e.attr("codeSystem");e=a.tag("translation");var o=e.attr("displayName"),p=e.attr("code"),q=e.attr("codeSystem"),s=e.attr("codeSystemName");e=a.tag("performer");var t=e.tag("name").val(),u=e.attr("code"),v=e.attr("codeSystem"),w=e.attr("codeSystemName");e=a.tag("participant");var x=e.tag("name").val();l=e.elsByTag("streetAddressLine"),r=[];for(var y=0;y<l.length;y++)r.push(l[y].val());var z=e.tag("city").val(),A=e.tag("state").val(),B=e.tag("postalCode").val(),C=e.tag("country").val();g.encounters.push({date:c,name:d,code:f,code_system:h,code_system_name:i,code_system_version:j,finding:{name:k,code:m,code_system:n},translation:{name:o,code:p,code_system:q,code_system_name:s},performer:{name:t,code:u,code_system:v,code_system_name:w},location:{organization:x,street:r,city:z,state:A,zip:B,country:C}})}),g.immunizations=[];var Y=a.section("immunizations");Y.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.attr("value"));e=a.template("2.16.840.1.113883.10.20.1.53").tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.1.53").tag("translation");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=a.tag("routeCode");var n=e.attr("displayName"),o=e.attr("code"),p=e.attr("codeSystem"),q=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.1.49");var r=e.tag("text").val();e=e.tag("code");var s=e.attr("displayName"),t=e.attr("code"),u=e.attr("codeSystem");g.immunizations.push({date:c,product:{name:d,code:f,code_system:h,code_system_name:i,translation:{name:j,code:k,code_system:l,code_system_name:m}},route:{name:n,code:o,code_system:p,code_system_name:q},instructions:r,education_type:{name:s,code:t,code_system:u}})}),g.labs=[];var Z=a.section("labs");Z.entries().each(function(a){e=a.tag("effectiveTime");var c=b(a.tag("effectiveTime").attr("value"));c||(c=b(a.tag("effectiveTime").tag("low").attr("value"))),e=a.tag("code");for(var d,f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem"),j=e.attr("codeSystemName"),k=a.elsByTag("component"),l=[],m=0;m<k.length;m++)if(d=k[m],d.template("2.16.840.1.113883.10.20.1.31").val()){var n=b(d.tag("effectiveTime").attr("value"));e=d.tag("code");var o=e.attr("displayName"),p=e.attr("code"),q=e.attr("codeSystem"),r=e.attr("codeSystemName");e=d.tag("value");var s=parseFloat(e.attr("value")),t=e.attr("unit");e=d.tag("referenceRange");var u=e.tag("observationRange").tag("text").val(),v=e.tag("observationRange").tag("low").attr("unit"),w=e.tag("observationRange").tag("low").attr("value"),x=e.tag("observationRange").tag("high").attr("unit"),y=e.tag("observationRange").tag("high").attr("value");l.push({date:n,name:o,value:s,unit:t,code:p,code_system:q,code_system_name:r,reference_range:{text:u,low_unit:v,low_value:w,high_unit:x,high_value:y}})}g.labs.push({name:f,code:h,code_system:i,code_system_name:j,date:c,results:l})}),g.medications=[];var $=a.section("medications");$.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.tag("manufacturedProduct").tag("code");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem");e=a.tag("manufacturedProduct").tag("translation");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=a.tag("doseQuantity");var n=e.attr("value"),o=e.attr("unit");e=a.tag("rateQuantity");var p=e.attr("value"),q=e.attr("unit");e=a.tag("precondition").tag("value");var r=e.attr("displayName"),s=e.attr("code"),t=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.1.28").tag("value");var u=e.attr("displayName"),v=e.attr("code"),w=e.attr("codeSystem");e=a.tag("routeCode");var x=e.attr("displayName"),y=e.attr("code"),z=e.attr("codeSystem"),A=e.attr("codeSystemName");e=a.tag("participant").tag("code");var B=e.attr("displayName"),C=e.attr("code"),D=e.attr("codeSystem"),E=e.attr("codeSystemName");e=a.tag("administrationUnitCode");var F=e.attr("displayName"),G=e.attr("code"),H=e.attr("codeSystem"),I=e.attr("codeSystemName");e=a.tag("performer");var J=e.tag("name").val(),K=null;g.medications.push({date_range:{start:c,end:d},product:{name:f,code:h,code_system:i,translation:{name:j,code:k,code_system:l,code_system_name:m}},dose_quantity:{value:n,unit:o},rate_quantity:{value:p,unit:q},precondition:{name:r,code:s,code_system:t},reason:{name:u,code:v,code_system:w},route:{name:x,code:y,code_system:z,code_system_name:A},vehicle:{name:B,code:C,code_system:D,code_system_name:E},administration:{name:F,code:G,code_system:H,code_system_name:I},prescriber:{organization:J,person:K}})}),g.problems=[];var _=a.section("problems");_.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.template("2.16.840.1.113883.10.20.1.28").tag("value");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.1.50");var j=e.tag("value").attr("displayName");e=a.template("2.16.840.1.113883.10.20.1.38");var k=parseFloat(e.tag("value").attr("value"));g.problems.push({date_range:{start:c,end:d},name:f,status:j,age:k,code:h,code_system:i})}),g.procedures=[];var ab=a.section("procedures");ab.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.attr("value"));e=a.tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=null,j=null,k=null;e=a.tag("performer").tag("addr");var m=e.tag("name").val(),n=e.tag("telecom").attr("value");l=e.elsByTag("streetAddressLine"),r=[];for(var o=0;o<l.length;o++)r.push(l[o].val());var p=e.tag("city").val(),q=e.tag("state").val(),s=e.tag("postalCode").val(),t=e.tag("country").val();e=a.tag("participant").tag("code");var u=e.attr("displayName"),v=e.attr("code"),w=e.attr("codeSystem");g.procedures.push({date:c,name:d,code:f,code_system:h,specimen:{name:i,code:j,code_system:k},performer:{organization:m,street:r,city:p,state:q,zip:s,country:t,phone:n},device:{name:u,code:v,code_system:w}})}),g.vitals=[];var bb=a.section("vitals");return bb.entries().each(function(a){e=a.tag("effectiveTime");for(var c,d=b(e.attr("value")),f=a.elsByTag("component"),h=[],i=0;i<f.length;i++){c=f[i],e=c.tag("code");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=c.tag("value");var n=parseFloat(e.attr("value")),o=e.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}g.vitals.push({date:d,results:h})}),g};return{run:g}}();var d=d||{};d.CCDA=function(){var b=a.parseDate,d=function(a){return a.section=f,a},e=function(){var a=function(a){for(var b=0;b<this.length;b++)a(this[b])},b=this.elsByTag("entry");return b.each=a,b},f=function(a){var b;switch(a){case"allergies":return b=this.template("2.16.840.1.113883.10.20.22.2.6.1"),b.entries=e,b;case"demographics":return b=this.template("2.16.840.1.113883.10.20.22.1.1"),b.entries=e,b;case"encounters":return b=this.template("2.16.840.1.113883.10.20.22.2.22"),b.isEmpty()?(b=this.template("2.16.840.1.113883.10.20.22.2.22.1"),b.entries=e,b):(b.entries=e,b);case"immunizations":return b=this.template("2.16.840.1.113883.10.20.22.2.2.1"),b.isEmpty()?(b=this.template("2.16.840.1.113883.10.20.22.2.2"),b.entries=e,b):(b.entries=e,b);case"labs":return b=this.template("2.16.840.1.113883.10.20.22.2.3.1"),b.entries=e,b;case"medications":return b=this.template("2.16.840.1.113883.10.20.22.2.1.1"),b.entries=e,b;case"problems":return b=this.template("2.16.840.1.113883.10.20.22.2.5.1"),b.isEmpty()?(b=this.template("2.16.840.1.113883.10.20.22.2.5"),b.entries=e,b):(b.entries=e,b);case"procedures":if(b=this.template("2.16.840.1.113883.10.20.22.2.7.1"),!b.isEmpty())return b.entries=e,b;b=this.template("2.16.840.1.113883.10.20.22.2.7");break;case"vitals":return b=this.template("2.16.840.1.113883.10.20.22.2.4.1"),b.entries=e,b}return null},g=function(a){var e,f,g={};a=d(a),g.allergies=[];var h=a.section("allergies");h&&h.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.template("2.16.840.1.113883.10.20.22.4.7").tag("code");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem"),j=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.22.4.7").tag("value");var k=e.attr("displayName"),l=e.attr("code"),m=e.attr("codeSystem"),n=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.22.4.9").tag("value");var o=e.attr("displayName"),p=e.attr("code"),q=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.22.4.8").tag("value");var r=e.attr("displayName");e=a.tag("participant").tag("code");var s=e.attr("displayName"),t=e.attr("code"),u=e.attr("codeSystem"),v=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.22.4.28").tag("value");var w=e.attr("displayName");g.allergies.push({date_range:{start:c,end:d},name:f,code:h,code_system:i,code_system_name:j,status:w,severity:r,reaction:{name:o,code:p,code_system:q},reaction_type:{name:k,code:l,code_system:m,code_system_name:n},allergen:{name:s,code:t,code_system:u,code_system_name:v}})}),g.demographics={};var i=a.section("demographics"),j=i.tag("patientRole");e=j.tag("patient").tag("name");var k=e.tag("prefix").val(),l=e.elsByTag("given"),m=[];for(f=0;f<l.length;f++)m.push(l[f].val());var n=e.tag("family").val();e=j.tag("patient");var o=b(e.tag("birthTime").attr("value")),p=c.gender(e.tag("administrativeGenderCode").attr("code")),q=c.maritalStatus(e.tag("maritalStatusCode").attr("code"));e=j.tag("addr"),l=e.elsByTag("streetAddressLine");var r=[];for(f=0;f<l.length;f++)r.push(l[f].val());var s=e.tag("city").val(),t=e.tag("state").val(),u=e.tag("postalCode").val(),v=e.tag("country").val();e=j.tag("telecom");var w=e.attr("value"),x=null,y=null,z=null,A=j.tag("languageCommunication").tag("languageCode").attr("code"),B=j.tag("raceCode").attr("displayName"),C=j.tag("ethnicGroupCode").attr("displayName"),D=j.tag("religiousAffiliationCode").attr("displayName");e=j.tag("birthplace");var E=e.tag("state").val(),F=e.tag("postalCode").val(),G=e.tag("country").val();e=j.tag("guardian");var H=e.tag("code").attr("displayName"),I=e.tag("telecom").attr("value");e=e.tag("guardianPerson"),l=e.elsByTag("given");var J=[];for(f=0;f<l.length;f++)J.push(l[f].val());var K=e.tag("family").val();e=j.tag("guardian").tag("addr"),l=e.elsByTag("streetAddressLine");var L=[];for(f=0;f<l.length;f++)L.push(l[f].val());var M=e.tag("city").val(),N=e.tag("state").val(),O=e.tag("postalCode").val(),P=e.tag("country").val();e=j.tag("providerOrganization");var Q=e.tag("name").val(),R=e.tag("telecom").attr("value");l=e.elsByTag("streetAddressLine");var S=[];for(f=0;f<l.length;f++)S.push(l[f].val());var T=e.tag("city").val(),U=e.tag("state").val(),V=e.tag("postalCode").val(),W=e.tag("country").val();g.demographics={name:{prefix:k,given:m,family:n},dob:o,gender:p,marital_status:q,address:{street:r,city:s,state:t,zip:u,country:v},phone:{home:w,work:x,mobile:y},email:z,language:A,race:B,ethnicity:C,religion:D,birthplace:{state:E,zip:F,country:G},guardian:{name:{given:J,family:K},relationship:H,address:{street:L,city:M,state:N,zip:O,country:P},phone:{home:I}},provider:{organization:Q,phone:R,address:{street:S,city:T,state:U,zip:V,country:W}}},g.encounters=[];var X=a.section("encounters");X&&X.entries().each(function(a){var c=b(a.tag("effectiveTime").attr("value"));e=a.tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=e.attr("codeSystemName"),j=e.attr("codeSystemVersion");e=a.tag("value");var k=e.attr("displayName"),m=e.attr("code"),n=e.attr("codeSystem");e=a.tag("translation");var o=e.attr("displayName"),p=e.attr("code"),q=e.attr("codeSystem"),s=e.attr("codeSystemName");e=a.tag("performer").tag("code");var t=e.attr("displayName"),u=e.attr("code"),v=e.attr("codeSystem"),w=e.attr("codeSystemName");e=a.tag("participant");var x=e.tag("code").attr("displayName");l=e.elsByTag("streetAddressLine"),r=[];for(var y=0;y<l.length;y++)r.push(l[y].val());var z=e.tag("city").val(),A=e.tag("state").val(),B=e.tag("postalCode").val(),C=e.tag("country").val();g.encounters.push({date:c,name:d,code:f,code_system:h,code_system_name:i,code_system_version:j,finding:{name:k,code:m,code_system:n},translation:{name:o,code:p,code_system:q,code_system_name:s},performer:{name:t,code:u,code_system:v,code_system_name:w},location:{organization:x,street:r,city:z,state:A,zip:B,country:C}})}),g.immunizations=[];var Y=a.section("immunizations");Y&&Y.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.attr("value"));e=a.template("2.16.840.1.113883.10.20.22.4.54").tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.22.4.54").tag("translation");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=a.tag("routeCode");var n=e.attr("displayName"),o=e.attr("code"),p=e.attr("codeSystem"),q=e.attr("codeSystemName");e=a.template("2.16.840.1.113883.10.20.22.4.20");var r=e.tag("text").val();e=e.tag("code");var s=e.attr("displayName"),t=e.attr("code"),u=e.attr("codeSystem");g.immunizations.push({date:c,product:{name:d,code:f,code_system:h,code_system_name:i,translation:{name:j,code:k,code_system:l,code_system_name:m}},route:{name:n,code:o,code_system:p,code_system_name:q},instructions:r,education_type:{name:s,code:t,code_system:u}})}),g.labs=[];var Z=a.section("labs");Z&&Z.entries().each(function(a){e=a.tag("code");for(var c,d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=e.attr("codeSystemName"),j=a.elsByTag("component"),k=[],l=0;l<j.length;l++){c=j[l];var m=b(c.tag("effectiveTime").attr("value"));e=c.tag("code");var n=e.attr("displayName"),o=e.attr("code"),p=e.attr("codeSystem"),q=e.attr("codeSystemName");e=c.tag("value");var r=parseFloat(e.attr("value")),s=e.attr("unit");e=c.tag("referenceRange");var t=e.tag("observationRange").tag("text").val(),u=e.tag("observationRange").tag("low").attr("unit"),v=e.tag("observationRange").tag("low").attr("value"),w=e.tag("observationRange").tag("high").attr("unit"),x=e.tag("observationRange").tag("high").attr("value");k.push({date:m,name:n,value:r,unit:s,code:o,code_system:p,code_system_name:q,reference_range:{text:t,low_unit:u,low_value:v,high_unit:w,high_value:x}})}g.labs.push({name:d,code:f,code_system:h,code_system_name:i,results:k})}),g.medications=[];var $=a.section("medications");$&&$.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.tag("manufacturedProduct").tag("code");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem");e=a.tag("manufacturedProduct").tag("translation");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=a.tag("doseQuantity");var n=e.attr("value"),o=e.attr("unit");e=a.tag("rateQuantity");var p=e.attr("value"),q=e.attr("unit");e=a.tag("precondition").tag("value");var r=e.attr("displayName"),s=e.attr("code"),t=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.22.4.19").tag("value");var u=e.attr("displayName"),v=e.attr("code"),w=e.attr("codeSystem");e=a.tag("routeCode");var x=e.attr("displayName"),y=e.attr("code"),z=e.attr("codeSystem"),A=e.attr("codeSystemName");e=a.tag("participant").tag("code");var B=e.attr("displayName"),C=e.attr("code"),D=e.attr("codeSystem"),E=e.attr("codeSystemName");e=a.tag("administrationUnitCode");var F=e.attr("displayName"),G=e.attr("code"),H=e.attr("codeSystem"),I=e.attr("codeSystemName");e=a.tag("performer");var J=e.tag("name").val(),K=null;g.medications.push({date_range:{start:c,end:d},product:{name:f,code:h,code_system:i,translation:{name:j,code:k,code_system:l,code_system_name:m}},dose_quantity:{value:n,unit:o},rate_quantity:{value:p,unit:q},precondition:{name:r,code:s,code_system:t},reason:{name:u,code:v,code_system:w},route:{name:x,code:y,code_system:z,code_system_name:A},vehicle:{name:B,code:C,code_system:D,code_system_name:E},administration:{name:F,code:G,code_system:H,code_system_name:I},prescriber:{organization:J,person:K}})}),g.problems=[];var _=a.section("problems");_&&_.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.tag("low").attr("value")),d=b(e.tag("high").attr("value"));e=a.template("2.16.840.1.113883.10.20.22.4.4").tag("value");var f=e.attr("displayName"),h=e.attr("code"),i=e.attr("codeSystem");e=a.template("2.16.840.1.113883.10.20.22.4.6");var j=e.tag("value").attr("displayName");e=a.template("2.16.840.1.113883.10.20.22.4.31");var k=parseFloat(e.tag("value").attr("value"));g.problems.push({date_range:{start:c,end:d},name:f,status:j,age:k,code:h,code_system:i})}),g.procedures=[];var ab=a.section("procedures");ab&&ab.entries().each(function(a){e=a.tag("effectiveTime");var c=b(e.attr("value"));e=a.tag("code");var d=e.attr("displayName"),f=e.attr("code"),h=e.attr("codeSystem"),i=null,j=null,k=null;e=a.tag("performer").tag("addr");var m=e.tag("name").val(),n=e.tag("telecom").attr("value");l=e.elsByTag("streetAddressLine"),r=[];for(var o=0;o<l.length;o++)r.push(l[o].val());var p=e.tag("city").val(),q=e.tag("state").val(),s=e.tag("postalCode").val(),t=e.tag("country").val();e=a.tag("participant").tag("code");var u=e.attr("displayName"),v=e.attr("code"),w=e.attr("codeSystem");g.procedures.push({date:c,name:d,code:f,code_system:h,specimen:{name:i,code:j,code_system:k},performer:{organization:m,street:r,city:p,state:q,zip:s,country:t,phone:n},device:{name:u,code:v,code_system:w}})}),g.vitals=[];var bb=a.section("vitals");return bb&&bb.entries().each(function(a){e=a.tag("effectiveTime");for(var c,d=b(e.attr("value")),f=a.elsByTag("component"),h=[],i=0;i<f.length;i++){c=f[i],e=c.tag("code");var j=e.attr("displayName"),k=e.attr("code"),l=e.attr("codeSystem"),m=e.attr("codeSystemName");e=c.tag("value");var n=parseFloat(e.attr("value")),o=e.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}g.vitals.push({date:d,results:h})}),g};return{run:g}}();var e=function(a){var c=null,e="",f={},g=function(a){for(var b=function(){return JSON.stringify(this,null,2)},c=0;c<a.length;c++)a[c].json=b},h=function(){return f.document},i=function(){return f.allergies},j=function(){return f.demographics},k=function(){return f.encounters},l=function(){return f.immunizations},m=function(){return f.labs},n=function(){return f.medications},o=function(){return f.problems},p=function(){return f.procedures},q=function(){return f.vitals};switch(a=a.replace(/^\s+|\s+$/g,""),"<?xml"===a.substr(0,5)?(c=b.parse(a),c.template("2.16.840.1.113883.3.88.11.32.1").isEmpty()?c.template("2.16.840.1.113883.10.20.22.1.2").isEmpty()||(e="ccda"):e="c32"):e="json",e){case"c32":f=d.C32.run(c);break;case"ccda":f=d.CCDA.run(c);break;case"json":var r;try{r=JSON.parse(a)}catch(s){console.log("BB Exception: Could not parse JSON")}console.log("BB Error: Blue Button JSON not yet implemented."),console.log(r)}return f.document={type:e},g([f,f.document,f.allergies,f.demographics,f.encounters,f.immunizations,f.labs,f.medications,f.problems,f.procedures,f.vitals]),{xmlDOM:c,data:f,document:h,allergies:i,demographics:j,encounters:k,immunizations:l,labs:m,medications:n,problems:o,procedures:p,vitals:q}};return e});